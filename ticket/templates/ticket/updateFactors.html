{% extends "partials/layout.html" %}
{% block title %}
تسویه حساب
{% endblock %}
{% block content %}

<div class="m-portlet">
    <div class="m-portlet__body m-portlet__body--no-padding">
        <div class="row m-row--no-padding m-row--col-separator-xl">
            <div class="col-md-12 col-lg-12 col-xl-4">

                <!--begin:: Widgets/Stats2-1 -->
                <div class="m-widget1">
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">شماره فاکتور</h3>
                                <span class="m-widget1__desc"></span>
                            </div>
                            <div class="col m--align-right">
                                <span id="factor_code" class="m-widget1__number m--font-brand"
                                    style="font-size:1rem !important">{{factor_code}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">مشتری</h3>
                                <span class="m-widget1__desc">نام و نام خانوادگی مشتری</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="customer_name" class="m-widget1__number m--font-danger"
                                    style="font-size:1rem !important">{{customer}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">حسابدار</h3>
                                <span class="m-widget1__desc">نام و نام خانوادگی حسابدار </span>
                            </div>
                            <div class="col m--align-right">
                                <span id="accountant_name" class="m-widget1__number m--font-success"
                                    style="font-size:1rem !important">{{accountant}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!--end:: Widgets/Stats2-1 -->
            </div>
            <div class="col-md-12 col-lg-12 col-xl-4">

                <!--begin:: Widgets/Stats2-2 -->
                <div class="m-widget1">
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">تاریخ ایجاد</h3>
                                <span class="m-widget1__desc">تاریخ تشکیل فاکتور</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="factor_created_date" class="m-widget1__number m--font-accent"
                                    style="font-size:1rem !important">{{created_date}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">تاریخ بروزرسانی</h3>
                                <span class="m-widget1__desc">تاریخ تصحیح فاکتور</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="factor_modified_date" class="m-widget1__number m--font-info"
                                    style="font-size:1rem !important">{{modified_date}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">وضعیت</h3>
                                <span class="m-widget1__desc">وضعیت پرداختی فاکتور</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="factor_status" class="m-widget1__number m--font-warning"
                                    style="font-size:1rem !important">{{factor_status}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!--begin:: Widgets/Stats2-2 -->
            </div>
            <div class="col-md-12 col-lg-12 col-xl-4">

                <!--begin:: Widgets/Stats2-3 -->
                <div class="m-widget1">
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">کل مبلغ</h3>
                                <span class="m-widget1__desc">کل مبلغ بدون احتساب تخفیف ها</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="total_amount"
                                    class="m-widget1__number m--font-success">{{total_amount}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">مبلغ قابل پرداخت</h3>
                                <span class="m-widget1__desc">مبلغ با احتساب تخفیف ها</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="final_amount" class="m-widget1__number m--font-danger">{{final_amount}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="m-widget1__item">
                        <div class="row m-row--no-padding align-items-center">
                            <div class="col">
                                <h3 class="m-widget1__title">مبلغ پرداخت نشده</h3>
                                <span class="m-widget1__desc">مانده مبلغی که پرداخت نشده</span>
                            </div>
                            <div class="col m--align-right">
                                <span id="remaining_amount"
                                    class="m-widget1__number m--font-primary">{{remaining_amount}}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!--begin:: Widgets/Stats2-3 -->
            </div>
        </div>
    </div>
</div>

<div class="m-portlet m-portlet--responsive-mobile" id="main_portlet">
    <div class="m-portlet__head">
        <div class="m-portlet__head-caption">
            <div class="m-portlet__head-title">
                <span class="m-portlet__head-icon m--hide">
                    <i class="la la-gear"></i>
                </span>
                <h3 class="m-portlet__head-text">
                    ریز فاکتور
                </h3>
            </div>
        </div>
    </div>
    <div class="m-portlet__body">

        <div class="m-accordion m-accordion--default m-accordion--solid m-accordion--section  m-accordion--toggle-arrow"
            id="m_accordion_7" role="tablist">

            {% for subfactor in subfactors %}
            <!--begin::Item-->
            <div class="m-accordion__item">
                <div class="m-accordion__item-head collapsed" role="tab"
                    id="m_accordion_7_item_{{subfactor.index}}_head" data-toggle="collapse"
                    href="#m_accordion_7_item_{{subfactor.index}}_body" aria-expanded="    false">
                    <span class="m-accordion__item-icon"><i class="fa flaticon-user-ok"></i></span>
                    <span class="m-accordion__item-title">زیر فاکتور شماره {{subfactor.index}}</span>
                    <span class="m-accordion__item-mode"></span>
                </div>
                <div class="m-accordion__item-body collapse" id="m_accordion_7_item_{{subfactor.index}}_body"
                    role="tabpanel" aria-labelledby="m_accordion_7_item_{{subfactor.index}}_head"
                    data-parent="#m_accordion_7">
                    <div class="m-accordion__item-content">
                        <br />
                        <div class="m-invoice__body m-invoice__body--centered">
                            <div class="table-responsive">
                                <table class="table  table-responsive-sm table-responsive-md">
                                    <thead>
                                        <tr>
                                            <th>تاریخ ایجاد فاکتور</th>
                                            <td>{{subfactor.created_date}}</td>
                                        </tr>
                                        <tr>
                                            <th>تاریخ اصلاح فاکتور</th>
                                            <td>{{subfactor.modified_date}}</td>
                                        </tr>
                                        <tr>
                                            <th>مبلغ کل</th>
                                            <td>{{subfactor.total}}</td>
                                        </tr>
                                        <tr>
                                            <th>مبلغ قابل پرداخت</th>
                                            <td>{{subfactor.final_amount}}</td>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                        <div
                            class="m-form__seperator m-form__seperator--dashed  m-form__seperator--space m--margin-bottom-40">
                        </div>
                        <div class="m-portlet__body">
                            <form class="m-form" action="/update-sub-factor/" method="POST">
                                <div class="form-group m-form__group row">

                                    <div class="col-lg-3">
                                        <label>هزینه های جانبی</label>
                                        <input type="text" name="side_fees" class="form-control m-input"
                                            placeholder="هزینه های جانبی" value="{{subfactor.side_fees}}">

                                    </div>
                                    <div class="col-lg-3">
                                        <label class="">تخفیف درصدی</label>
                                        <input type="text" name="discount_percent" class="form-control m-input"
                                            placeholder="%" value="{{subfactor.discount_percent}}">

                                    </div>
                                    <div class="col-lg-3">
                                        <label class="">تخفیف تومانی</label>
                                        <input type="text" name="discount_amount" class="form-control m-input"
                                            placeholder="تومان" value="{{subfactor.discount_amount}}">

                                    </div>
                                    <div class="col-lg-1">
                                        <br />
                                        {% csrf_token %}
                                        <input name="id" value="{{subfactor.id}}" hidden width="0px"
                                            height="0px" />
                                        <input name="next" type="text" hidden
                                            value="/update-factor/?code={{factor_code}}" />
                                        <button type="submit" class="btn m-btn--pill    btn-success">
                                            تایید</button>
                                    </div>

                                </div>
                            </form>
                        </div>
                        <div
                            class="m-form__seperator m-form__seperator--dashed  m-form__seperator--space m--margin-bottom-40">
                        </div>
                        <div class="m-portlet__body">
                            <table
                                class="dt table table-striped- table-bordered table-hover table-checkable dataTable no-footer dtr-inline  table-responsive-sm table-responsive-md"
                                role="grid" aria-describedby="m_table_1_info" style="width: 100%;">
                                <thead>
                                    <tr role="row">
                                        <th class="dt-right sorting_disabled" rowspan="1" colspan="1">
                                            <a href="#"
                                                class="m-portlet__nav-link btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill"
                                                title="View">
                                                <i class="la la-edit"></i>
                                            </a>
                                        </th>
                                        <th class="sorting_desc" tabindex="0" aria-controls="m_table_1" rowspan="1"
                                            colspan="1" style="width: 56.25px;" aria-sort="descending"
                                            aria-label="Order ID: activate to sort column ascending">خدمات</th>
                                        <th class="sorting" tabindex="0" aria-controls="m_table_1" rowspan="1"
                                            colspan="1" style="width: 67.25px;"
                                            aria-label="Ship City: activate to sort column ascending">تعداد</th>
                                        <th class="sorting" tabindex="0" aria-controls="m_table_1" rowspan="1"
                                            colspan="1" style="width: 77.25px;"
                                            aria-label="Ship Address: activate to sort column ascending">قیمت</th>
                                        <th class="sorting" tabindex="0" aria-controls="m_table_1" rowspan="1"
                                            colspan="1" style="width: 78.25px;"
                                            aria-label="Company Agent: activate to sort column ascending">تخفیف</th>
                                        <th class="sorting" tabindex="0" aria-controls="m_table_1" rowspan="1"
                                            colspan="1" style="width: 92.25px;"
                                            aria-label="Company Name: activate to sort column ascending">قیمت نهایی
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for subservice in subfactor.sub_services.all %}
                                    <tr>
                                        <td>
                                            <a href="/update_subservice?id={{subserivce.id}}/"
                                                class="m-portlet__nav-link btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill"
                                                title="View">
                                                <i class="la la-edit"></i>
                                            </a>
                                        </td>
                                        <td>{{subservice.service.name}}</td>
                                        <td>{{subservice.number}}</td>
                                        <td>{{subservice.price}}</td>
                                        <td>{{subservice.discount}}</td>
                                        <td></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div
                            class="m-form__seperator m-form__seperator--dashed  m-form__seperator--space m--margin-bottom-40">
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Item-->
            {% endfor %}
        </div>
    </div>

    <div class="m-portlet__body">
        <form class="m-form" id="f1" method="POST" action="/update-factor/">
            <div class="form-group m-form__group row justify-content-center">
                <div class="col-lg-4">
                    <div class="m-form__group m-form__group--inline">
                        <div class="m-form__control">
                            <label>نوع پرداخت</label>
                            <select class="form-control m-input m-input--square" name="payment_method"
                                style="width:100%">
                                <option selected disabled hidden>نوع پرداخت را انتخاب کنید</option>
                                {% for payment in payments %}
                                <option value="{{payment.code}}">{{payment.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-md-none m--margin-bottom-10"></div>
                </div>
                <div class="col-lg-3">
                    <div class="form-group m-form__group">
                        <label>مبلغ پرداختی</label>
                        <div class="input-group">
                            <input name="paid_amount" type="text" class="form-control m-input" placeholder="تومان">
                            <div class="input-group-prepend"><span class="input-group-text" id="basic-addon2">
                                    <i class="la la-money"></i>
                                </span></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-1">
                    <div class="form-group m-form__group">
                        <br />
                        <input name="next" type="text" hidden
                                            value="/update-factor/?code={{factor_code}}" />
                        <input type="text" name="code" value="{{factor_code}}" hidden/>
                        {% csrf_token %}
                        <button type="submit" class="btn m-btn--pill    btn-outline-success btn-lg m-btn m-btn--custom">
                            تایید</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


{% endblock %}
{% block footer %}
{% load static %}
<script src="{% static 'ticket/js/datatables.bundle.js' %}" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function () {
        $('table.dt').each(function (index, value) {
            $(this).find('tbody').find('tr').each(function (index, value) {
                console.log($($(this).children()[2]).text())
                let number = $($(this).children()[2]).text()
                let price = $($(this).children()[3]).text()
                let discount = $($(this).children()[4]).text()

                $($(this).children()[5]).text(number * price * (100 - discount) / 100)
            });
            $(this).DataTable();
        });

        $('select').select2();
    });

    function submitform(e) {

    }
</script>
{% endblock %}